<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AAAI Solutions - AI Chat</title>
  <link rel="shortcut icon" href="./robot.svg" type="image/svg+xml">
  <link rel="stylesheet" href="./assets/css/style.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Barlow:wght@600;700&family=Open+Sans:wght@400;500;700&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  
  <!-- Load configuration -->
  <script>
    try {
      document.head.appendChild(document.createElement('script')).src = './assets/js/config.js';
    } catch (e) {
      console.log('Config.js not found, using default configuration');
    }
  </script>
  
  <!-- Chat-specific styles -->
  <style>
    /* Environment indicator */
    .env-indicator {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 10000;
      padding: 5px 10px;
      text-align: center;
      font-size: 0.8rem;
      font-weight: bold;
      color: white;
      display: none;
    }
    
    .env-indicator.development {
      background-color: #f39c12;
      display: block;
    }
    
    .env-indicator.staging {
      background-color: #9b59b6;
      display: block;
    }
    
    body.with-env-indicator {
      padding-top: 30px;
    }

    /* Main content styles */
    .main-content {
      min-height: 100vh;
      background: linear-gradient(180deg, var(--rich-black-fogra-29) 0%, var(--space-cadet) 100%);
      padding-top: 80px;
    }

    /* Chat container styles */
    .chat-container {
      max-width: 1000px;
      margin: 20px auto;
      background-color: var(--independence);
      border-radius: var(--radius-15);
      overflow: hidden;
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
      position: relative;
      border: 1px solid rgba(255, 255, 255, 0.1);
      height: calc(100vh - 140px);
      display: flex;
      flex-direction: column;
    }
    
    /* Status indicators */
    .status-indicator {
      position: absolute;
      top: 15px;
      left: 50%;
      transform: translateX(-50%);
      padding: 8px 20px;
      border-radius: 25px;
      font-size: 0.9rem;
      font-weight: 600;
      opacity: 0;
      transition: all 0.3s ease;
      z-index: 1000;
      backdrop-filter: blur(10px);
    }
    
    .status-connected {
      background: linear-gradient(135deg, rgba(46, 204, 113, 0.9) 0%, rgba(39, 174, 96, 0.9) 100%);
      color: white;
    }
    
    .status-disconnected {
      background: linear-gradient(135deg, rgba(231, 76, 60, 0.9) 0%, rgba(192, 57, 43, 0.9) 100%);
      color: white;
    }
    
    .status-reconnecting {
      background: linear-gradient(135deg, rgba(243, 156, 18, 0.9) 0%, rgba(230, 126, 34, 0.9) 100%);
      color: white;
    }
    
    .status-indicator.visible {
      opacity: 1;
      transform: translateX(-50%) translateY(10px);
    }
    
    /* Chat header */
    .chat-header {
      background: linear-gradient(135deg, var(--indigo) 0%, var(--klein-blue) 100%);
      padding: 20px 25px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      flex-shrink: 0;
    }
    
    .chat-header-left {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .back-btn {
      background: transparent;
      border: 1px solid rgba(255, 255, 255, 0.3);
      color: var(--white);
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 0.9rem;
    }
    
    .back-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: rgba(255, 255, 255, 0.5);
    }
    
    .project-info {
      color: var(--white);
    }
    
    .project-title {
      font-size: 1.3rem;
      margin: 0 0 5px 0;
      font-weight: 600;
    }
    
    .project-subtitle {
      font-size: 0.85rem;
      color: rgba(255, 255, 255, 0.7);
      margin: 0;
    }
    
    .chat-env-info {
      font-size: 0.7rem;
      color: rgba(255, 255, 255, 0.6);
      margin-left: 10px;
    }
    
    .chat-header-right {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .user-info {
      display: flex;
      align-items: center;
      gap: 15px;
      color: var(--white);
    }
    
    .credits-badge {
      background: linear-gradient(135deg, var(--orange-soda) 0%, var(--red-orange) 100%);
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }
    
    .connection-status {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 0.8rem;
      color: rgba(255, 255, 255, 0.8);
    }
    
    .connection-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #e74c3c;
      animation: pulse 2s infinite;
    }
    
    .connection-dot.connected {
      background: #2ecc71;
    }
    
    .connection-dot.connecting {
      background: #f39c12;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    .project-menu-btn {
      background: transparent;
      border: 1px solid rgba(255, 255, 255, 0.3);
      color: var(--white);
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 1.2rem;
    }
    
    .project-menu-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: rgba(255, 255, 255, 0.5);
    }
    
    /* Chat body */
    .chat-body {
      flex: 1;
      padding: 20px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      background: linear-gradient(180deg, var(--space-cadet) 0%, var(--independence) 100%);
      scrollbar-width: thin;
      scrollbar-color: var(--orange-soda) transparent;
    }
    
    .chat-body::-webkit-scrollbar {
      width: 6px;
    }
    
    .chat-body::-webkit-scrollbar-track {
      background: transparent;
    }
    
    .chat-body::-webkit-scrollbar-thumb {
      background: var(--orange-soda);
      border-radius: 3px;
    }
    
    /* Welcome message */
    .welcome-message {
      text-align: center;
      padding: 40px 20px;
      color: rgba(255, 255, 255, 0.6);
    }
    
    .welcome-icon {
      font-size: 3rem;
      margin-bottom: 20px;
      opacity: 0.7;
    }
    
    .welcome-message h3 {
      color: var(--white);
      font-size: 1.3rem;
      margin-bottom: 10px;
    }
    
    .welcome-message p {
      font-size: 0.95rem;
      margin-bottom: 20px;
      max-width: 400px;
      margin-left: auto;
      margin-right: auto;
      line-height: 1.5;
    }
    
    .welcome-suggestions {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      justify-content: center;
      margin-top: 20px;
    }
    
    .suggestion-btn {
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: var(--white);
      padding: 8px 16px;
      border-radius: 20px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 0.85rem;
    }
    
    .suggestion-btn:hover {
      background: rgba(255, 255, 255, 0.2);
      border-color: var(--orange-soda);
    }
    
    /* Messages */
    .message {
      max-width: 75%;
      padding: 15px 20px;
      margin-bottom: 15px;
      border-radius: 18px;
      position: relative;
      line-height: 1.6;
      word-wrap: break-word;
      animation: fadeInUp 0.3s ease-out;
    }
    
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .message-bot {
      background: linear-gradient(135deg, var(--independence) 0%, var(--cadet-blue-crayola) 100%);
      color: var(--white);
      align-self: flex-start;
      border-bottom-left-radius: 6px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .message-user {
      background: linear-gradient(135deg, var(--klein-blue) 0%, var(--indigo) 100%);
      color: var(--white);
      align-self: flex-end;
      border-bottom-right-radius: 6px;
    }
    
    .message-timestamp {
      font-size: 0.75rem;
      color: rgba(255, 255, 255, 0.6);
      margin-top: 8px;
      text-align: right;
    }
    
    .message-status {
      font-size: 0.7rem;
      color: rgba(255, 255, 255, 0.5);
      margin-top: 5px;
      text-align: right;
      font-style: italic;
    }
    
    /* Typing indicator */
    .typing-indicator {
      display: flex;
      align-items: center;
      padding: 15px 20px;
      background: linear-gradient(135deg, var(--independence) 0%, var(--cadet-blue-crayola) 100%);
      border-radius: 18px;
      border-bottom-left-radius: 6px;
      margin-bottom: 15px;
      width: fit-content;
      align-self: flex-start;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .typing-dot {
      width: 8px;
      height: 8px;
      background-color: var(--white);
      border-radius: 50%;
      margin: 0 3px;
      animation: typing-animation 1.4s infinite ease-in-out;
    }
    
    .typing-dot:nth-child(2) {
      animation-delay: 0.2s;
    }
    
    .typing-dot:nth-child(3) {
      animation-delay: 0.4s;
    }
    
    @keyframes typing-animation {
      0%, 100% {
        transform: translateY(0);
        opacity: 0.7;
      }
      50% {
        transform: translateY(-8px);
        opacity: 1;
      }
    }
    
    /* Message history section */
    .message-history-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 15px;
      background-color: rgba(0, 0, 0, 0.2);
      border-radius: 5px;
      margin-bottom: 15px;
    }
    
    .message-history-title {
      font-size: 0.9rem;
      color: rgba(255, 255, 255, 0.7);
    }
    
    .message-history-actions {
      display: flex;
      gap: 10px;
    }
    
    .message-history-button {
      background: transparent;
      border: none;
      color: white;
      cursor: pointer;
      font-size: 0.8rem;
      padding: 5px;
      border-radius: 3px;
      transition: background-color 0.3s ease;
    }
    
    .message-history-button:hover {
      background: rgba(255, 255, 255, 0.1);
    }
    
    /* Chat footer */
    .chat-footer {
      display: flex;
      padding: 20px;
      background: linear-gradient(135deg, var(--independence) 0%, var(--space-cadet) 100%);
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      gap: 15px;
      flex-shrink: 0;
    }
    
    .chat-input {
      flex: 1;
      background: rgba(255, 255, 255, 0.1);
      color: var(--white);
      border: 2px solid transparent;
      padding: 15px 20px;
      border-radius: 25px;
      font-size: 1rem;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
      resize: none;
      min-height: 54px;
      max-height: 120px;
    }
    
    .chat-input:focus {
      outline: none;
      border-color: var(--orange-soda);
      background: rgba(255, 255, 255, 0.15);
    }
    
    .chat-input::placeholder {
      color: rgba(255, 255, 255, 0.6);
    }
    
    .chat-send-btn {
      background: linear-gradient(135deg, var(--orange-soda) 0%, var(--red-orange) 100%);
      color: white;
      border: none;
      padding: 15px 25px;
      border-radius: 25px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: 600;
      white-space: nowrap;
      display: flex;
      align-items: center;
      gap: 8px;
      position: relative;
      overflow: hidden;
    }
    
    .chat-send-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(255, 126, 95, 0.4);
    }
    
    .chat-send-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
      background: linear-gradient(135deg, #6c7b7f 0%, #95a5a6 100%);
    }
    
    .chat-send-btn:disabled::after {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, 
        transparent, 
        rgba(255, 255, 255, 0.1), 
        transparent);
      animation: loading-shimmer 1.5s infinite;
    }
    
    @keyframes loading-shimmer {
      to {
        left: 100%;
      }
    }
    
    .chat-send-btn:disabled span {
      opacity: 0.7;
    }
    
    .chat-send-btn:disabled ion-icon {
      opacity: 0.7;
      animation: pulse-icon 1.5s ease-in-out infinite;
    }
    
    @keyframes pulse-icon {
      0%, 100% {
        opacity: 0.7;
      }
      50% {
        opacity: 0.3;
      }
    }

    /* UI Components Styling */
    .chat-components-container {
      margin-top: 15px;
    }
    
    /* Button Component */
    .chat-component-button {
      padding: 10px 18px;
      border-radius: 20px;
      font-size: 0.9rem;
      border: none;
      background: linear-gradient(135deg, var(--klein-blue) 0%, var(--indigo) 100%);
      color: white;
      cursor: pointer;
      margin: 5px;
      transition: all 0.3s ease;
      font-weight: 500;
    }
    
    .chat-component-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }
    
    .chat-button-primary {
      background: linear-gradient(135deg, var(--klein-blue) 0%, var(--indigo) 100%);
    }
    
    .chat-button-secondary {
      background: linear-gradient(135deg, var(--independence) 0%, var(--cadet-blue-crayola) 100%);
    }
    
    .chat-button-success {
      background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
    }
    
    .chat-button-danger {
      background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
    }
    
    /* Card Component */
    .chat-component-card {
      width: 100%;
      max-width: 300px;
      background: linear-gradient(135deg, var(--independence) 0%, var(--cadet-blue-crayola) 100%);
      border-radius: 12px;
      overflow: hidden;
      margin: 15px 0;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .chat-card-image {
      width: 100%;
      height: 160px;
      overflow: hidden;
    }
    
    .chat-card-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      transition: transform 0.3s ease;
    }
    
    .chat-card-image:hover img {
      transform: scale(1.05);
    }
    
    .chat-card-content {
      padding: 20px;
    }
    
    .chat-card-title {
      font-size: 1.2rem;
      margin: 0 0 8px 0;
      color: white;
      font-weight: 600;
    }
    
    .chat-card-subtitle {
      font-size: 0.9rem;
      color: rgba(255, 255, 255, 0.8);
      margin: 0 0 20px 0;
      line-height: 1.5;
    }
    
    .chat-card-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    
    /* Quick Replies */
    .chat-component-quick-replies {
      width: 100%;
      margin: 15px 0;
    }
    
    .chat-quick-replies-title {
      font-size: 0.9rem;
      color: rgba(255, 255, 255, 0.8);
      margin-bottom: 12px;
      font-weight: 500;
    }
    
    .chat-quick-replies-options {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    
    .chat-quick-reply-button {
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.85rem;
      border: 1px solid rgba(255, 255, 255, 0.3);
      background-color: transparent;
      color: white;
      cursor: pointer;
      transition: all 0.3s ease;
      backdrop-filter: blur(5px);
    }
    
    .chat-quick-reply-button:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: var(--orange-soda);
      transform: translateY(-1px);
    }
    
    /* Contact List */
    .chat-component-contact-list {
      width: 100%;
      margin: 15px 0;
    }
    
    .chat-contact-item {
      display: flex;
      align-items: center;
      padding: 15px;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.05);
      margin-bottom: 8px;
      transition: all 0.3s ease;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .chat-contact-item:hover {
      background: rgba(255, 255, 255, 0.1);
      transform: translateX(5px);
    }
    
    .chat-contact-icon {
      width: 35px;
      height: 35px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 15px;
      color: var(--orange-soda);
      font-size: 1.2rem;
    }
    
    .chat-contact-content {
      flex: 1;
    }
    
    .chat-contact-title {
      font-size: 0.85rem;
      color: rgba(255, 255, 255, 0.7);
      margin-bottom: 3px;
    }
    
    .chat-contact-value {
      font-size: 1rem;
      color: white;
      font-weight: 500;
    }
    
    .chat-contact-copy {
      background: transparent;
      border: 1px solid rgba(255, 255, 255, 0.3);
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      position: relative;
      transition: all 0.3s ease;
    }
    
    .chat-contact-copy:hover {
      background: rgba(255, 255, 255, 0.1);
      border-color: var(--orange-soda);
    }
    
    .chat-contact-copy::after {
      content: 'Copied!';
      position: absolute;
      top: -35px;
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
      color: white;
      padding: 5px 10px;
      border-radius: 5px;
      font-size: 0.8rem;
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none;
      white-space: nowrap;
    }
    
    .chat-contact-copy.copied::after {
      opacity: 1;
    }

    /* Responsive design */
    @media (max-width: 768px) {
      .main-content {
        padding-top: 60px;
      }
      
      .chat-container {
        margin: 10px;
        height: calc(100vh - 80px);
        border-radius: var(--radius-10);
      }
      
      .chat-header {
        padding: 15px 20px;
        flex-wrap: wrap;
        gap: 10px;
      }
      
      .chat-header-right {
        gap: 10px;
      }
      
      .user-info {
        gap: 10px;
      }
      
      .user-info span {
        display: none;
      }
      
      .chat-footer {
        padding: 15px;
        flex-direction: column;
        gap: 10px;
      }
      
      .chat-send-btn {
        padding: 12px 20px;
        align-self: flex-end;
      }
      
      .message {
        max-width: 90%;
      }
      
      .project-title {
        font-size: 1.1rem;
      }
      
      .back-btn span {
        display: none;
      }
    }
  </style>
</head>

<body id="top">
  <!-- Environment indicator -->
  <div class="env-indicator" id="envIndicator">
    <span id="envText"></span>
  </div>

  <!-- Header -->
  <header class="header" data-header>
    <div class="container">
      <a href="index.html">
        <h1 class="logo">Aaai Solutions</h1>
      </a>
      <button class="nav-toggle-btn" aria-label="Toggle Menu" data-nav-toggle-btn>
        <ion-icon name="menu-outline" class="menu-icon"></ion-icon>
        <ion-icon name="close-outline" class="close-icon"></ion-icon>
      </button>
      <nav class="navbar container">
        <ul class="navbar-list">
          <li><a href="index.html" class="navbar-link" data-nav-link>Home</a></li>
          <li><a href="index.html#about" class="navbar-link" data-nav-link>About</a></li>
          <li><a href="index.html#solutions" class="navbar-link" data-nav-link>Solutions</a></li>
          <li><a href="index.html#applications" class="navbar-link" data-nav-link>Pursuits</a></li>
          <li><a href="index.html#contact" class="navbar-link" data-nav-link>Contact</a></li>
          <li><a href="https://calendly.com/shash-aaai/30min" class="btn btn-primary">Schedule a Demo</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <main class="main-content">
    <!-- Chat Container -->
    <div class="chat-container">
      <!-- Status Indicators -->
      <div class="status-indicator status-connected">✓ Connected</div>
      <div class="status-indicator status-disconnected">✗ Disconnected</div>
      <div class="status-indicator status-reconnecting">⟳ Reconnecting...</div>
      
      <!-- Chat Header -->
      <div class="chat-header">
        <div class="chat-header-left">
          <button class="back-btn" id="backBtn" title="Back to Project">
            <ion-icon name="arrow-back-outline"></ion-icon>
            <span>Projects</span>
          </button>
          <div class="project-info">
            <h3 class="project-title" id="projectTitle">Loading Project...</h3>
            <p class="project-subtitle" id="projectSubtitle">Intelligent AI Assistant</p>
            <span class="chat-env-info" id="chatEnvInfo"></span>
          </div>
        </div>
        
        <div class="chat-header-right">
          <div class="connection-status" id="connectionStatus">
            <div class="connection-dot" id="connectionDot"></div>
            <span id="connectionText">Disconnected</span>
          </div>
          <div class="user-info">
            <span class="credits-badge" id="creditsDisplay">Credits: 0</span>
            <span id="userEmail">user@example.com</span>
          </div>
          <button class="project-menu-btn" id="projectMenuBtn" title="Project Options">
            <ion-icon name="ellipsis-vertical-outline"></ion-icon>
          </button>
        </div>
      </div>
      
      <div id="connectionError" style="display:none; text-align:center; padding:20px; background:rgba(231,76,60,0.1); border-radius:10px; margin:10px;">
        <p>Connection error: Your session may have expired.</p>
        <button id="reconnectBtn" class="chat-send-btn" style="margin:10px auto; display:inline-block;">
          <ion-icon name="refresh-outline"></ion-icon>
          <span>Reconnect</span>
        </button>
      </div>

      <!-- Chat Body -->
      <div class="chat-body" id="chatBody">
        <!-- Message history header -->
        <div class="message-history-header" id="historyHeader" style="display: none;">
          <div class="message-history-title">Previous Conversations</div>
          <div class="message-history-actions">
            <button class="message-history-button" id="clearHistoryBtn" title="Clear History">
              <ion-icon name="trash-outline"></ion-icon>
            </button>
          </div>
        </div>
        
        <!-- Welcome message -->
        <div class="welcome-message" id="welcomeMessage">
          <div class="welcome-icon">🤖</div>
          <h3>Welcome to Your AI Project!</h3>
          <p>Start a conversation with your intelligent assistant. Ask questions, get insights, or explore ideas together.</p>
          <div class="welcome-suggestions">
            <button class="suggestion-btn" onclick="sendSuggestion('What can you help me with?')">What can you help me with?</button>
            <button class="suggestion-btn" onclick="sendSuggestion('Tell me about this project')">About this project</button>
            <button class="suggestion-btn" onclick="sendSuggestion('Give me some creative ideas')">Creative ideas</button>
          </div>
        </div>
        
        <!-- Messages will be inserted here -->
      </div>
      
      <!-- Chat Footer -->
      <div class="chat-footer">
        <textarea class="chat-input" id="messageInput" placeholder="Type your message here..." maxlength="1000" rows="1"></textarea>
        <button class="chat-send-btn" id="sendMessageBtn">
          <ion-icon name="send"></ion-icon>
          <span>Send</span>
        </button>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="footer">
    <div class="container">
      <p class="copyright">
        &copy; 2024 <a href="#" class="copyright-link">Aaai Solutions</a>. All Rights Reserved
      </p>
      <ul class="footer-list">
        <li><a href="terms_conditions.html" class="footer-link">Terms & Conditions</a></li>
        <li><a href="privacy_policy.html" class="footer-link">Privacy Policy</a></li>
        <li><a href="https://docs.google.com/document/d/1ZH5H3gvn3b9xcXepwS9wx7juUfULOvW5MPSKCX3bYu4/edit?addon_store&pli=1#heading=h.ednect7ygrp2" class="footer-link">Bylaws</a></li>
      </ul>
    </div>
  </footer>

  <a href="#top" class="back-to-top" data-back-to-top>BACK TOP</a>

  <!-- Scripts -->
  <script src="./assets/js/script.js"></script>
  <script src="./assets/js/auth.js"></script>
  <script src="./assets/js/websocket-chat.js"></script>
  <script src="./assets/js/ui-components.js"></script>
  <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js"></script>
  <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js"></script>
  
  <!-- Chat application script -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Enhanced application state
      let chatService = null;
      let currentProject = null;
      let uiRenderer = null;
      let authCheckInterval = null;
      let connectionRetryCount = 0;
      let maxConnectionRetries = 3;
      let isInitializing = false;
      
      // DOM elements
      const elements = {
          projectTitle: document.getElementById('projectTitle'),
          projectSubtitle: document.getElementById('projectSubtitle'),
          userEmail: document.getElementById('userEmail'),
          creditsDisplay: document.getElementById('creditsDisplay'),
          connectionDot: document.getElementById('connectionDot'),
          connectionText: document.getElementById('connectionText'),
          chatBody: document.getElementById('chatBody'),
          messageInput: document.getElementById('messageInput'),
          sendMessageBtn: document.getElementById('sendMessageBtn'),
          welcomeMessage: document.getElementById('welcomeMessage'),
          backBtn: document.getElementById('backBtn'),
          connectionError: document.getElementById('connectionError'),
          reconnectBtn: document.getElementById('reconnectBtn'),
          // Status indicators
          connectedStatus: document.querySelector('.status-connected'),
          disconnectedStatus: document.querySelector('.status-disconnected'),
          reconnectingStatus: document.querySelector('.status-reconnecting')
      };
      
      /**
      * COMPREHENSIVE FIX: Enhanced application initialization
      */
      async function initializeApp() {
          if (isInitializing) {
              console.log('⚠️ App already initializing, skipping...');
              return;
          }
          
          isInitializing = true;
          
          try {
              console.log('🚀 COMPREHENSIVE FIX: Starting enhanced chat application...');
              
              // Step 1: Initialize environment with enhanced error handling
              await initializeEnvironment();
              
              // Step 2: Enhanced authentication initialization
              const authSuccess = await initializeAuthentication();
              if (!authSuccess) {
                  console.log('❌ Authentication failed, redirecting to login');
                  redirectToLogin('Authentication initialization failed');
                  return;
              }
              
              console.log('✅ Authentication successful');
              
              // Step 3: Get and validate project ID
              const projectId = getProjectId();
              if (!projectId) {
                  console.log('❌ No project ID found, redirecting to projects');
                  redirectToProjects();
                  return;
              }
              
              console.log('📁 Project ID:', projectId);
              
              // Step 4: Initialize UI components
              await initializeUI();
              
              // Step 5: Load project data
              await loadProjectData(projectId);
              
              // Step 6: Initialize chat service with enhanced options
              await initializeChatService();
              
              // Step 7: Setup event listeners
              setupEventListeners();
              
              // Step 8: Start authentication monitoring
              startAuthMonitoring();
              
              // Step 9: Show connection success
              showStatusIndicator('connected', '✅ Application initialized');
              
              window.AAAI_LOGGER?.info('COMPREHENSIVE: Chat application initialized successfully');
              console.log('✅ COMPREHENSIVE: Chat application initialized successfully');
              
          } catch (error) {
              window.AAAI_LOGGER?.error('COMPREHENSIVE: Failed to initialize chat application:', error);
              console.error('❌ COMPREHENSIVE: Failed to initialize chat application:', error);
              showError('Failed to initialize chat. Please refresh the page.');
              showStatusIndicator('disconnected', '❌ Initialization failed');
          } finally {
              isInitializing = false;
          }
      }
      
      /**
      * Enhanced environment initialization
      */
      async function initializeEnvironment() {
          console.log('🌍 Initializing enhanced environment...');
          
          // Ensure AAAI_CONFIG exists
          if (!window.AAAI_CONFIG) {
              window.AAAI_CONFIG = {
                  API_BASE_URL: '',
                  WS_BASE_URL: window.location.origin,
                  ENVIRONMENT: 'production',
                  ENABLE_WEBSOCKETS: true,
                  ENABLE_DEBUG: false,
                  VERSION: '2.0'
              };
              
              window.AAAI_LOGGER = {
                  debug: () => {},
                  info: console.info.bind(console, '[INFO]'),
                  warn: console.warn.bind(console, '[WARN]'),
                  error: console.error.bind(console, '[ERROR]')
              };
              
              console.log('⚠️ Created fallback AAAI_CONFIG');
          }
          
          // Show environment indicator
          const environment = window.AAAI_CONFIG.ENVIRONMENT;
          if (environment !== 'production') {
              const envIndicator = document.getElementById('envIndicator');
              const envText = document.getElementById('envText');
              
              if (envIndicator && envText) {
                  envIndicator.className = `env-indicator ${environment}`;
                  envText.textContent = `${environment.toUpperCase()} Environment - Enhanced v${window.AAAI_CONFIG.VERSION || '2.0'}`;
                  document.body.classList.add('with-env-indicator');
              }
          }
          
          console.log('🌍 Environment:', environment, 'Version:', window.AAAI_CONFIG.VERSION);
      }
      
      /**
      * Enhanced authentication initialization
      */
      async function initializeAuthentication() {
          console.log('🔐 Initializing enhanced authentication...');
          
          try {
              // Check if AuthService is available
              if (typeof AuthService === 'undefined') {
                  throw new Error('AuthService not available');
              }
              
              // Initialize AuthService
              const authInitialized = AuthService.init();
              if (!authInitialized) {
                  console.log('❌ AuthService initialization failed');
                  return false;
              }
              
              // Validate authentication state
              const isAuthenticated = AuthService.isAuthenticated();
              if (!isAuthenticated) {
                  console.log('❌ User not authenticated');
                  return false;
              }
              
              // Get user info
              const user = AuthService.getCurrentUser();
              if (!user || !user.id || !user.email) {
                  console.log('❌ Invalid user information');
                  return false;
              }
              
              console.log('✅ Authentication validated for:', user.email);
              
              // Pre-validate session with server
              try {
                  console.log('🔍 Pre-validating session with server...');
                  
                  const sessionInfo = AuthService.getSessionInfo();
                  console.log('Session info:', {
                      authenticated: sessionInfo.authenticated,
                      tokenValid: sessionInfo.tokenValid,
                      hasRefreshToken: sessionInfo.hasRefreshToken
                  });
                  
                  // Refresh token if needed
                  if (!sessionInfo.tokenValid) {
                      console.log('🔄 Token needs refresh, attempting...');
                      await AuthService.refreshTokenIfNeeded();
                      console.log('✅ Token refreshed successfully');
                  }
                  
              } catch (sessionError) {
                  console.warn('⚠️ Session pre-validation failed (continuing anyway):', sessionError.message);
              }
              
              return true;
              
          } catch (error) {
              console.error('❌ Authentication initialization error:', error);
              return false;
          }
      }
      
      /**
      * Enhanced UI initialization
      */
      async function initializeUI() {
          console.log('🎨 Initializing enhanced UI...');
          
          try {
              // Display user info
              const user = AuthService.getCurrentUser();
              if (user && elements.userEmail) {
                  elements.userEmail.textContent = user.email;
                  console.log('👤 User displayed:', user.email);
              }
              
              // Load user credits with retry
              let creditsLoaded = false;
              for (let i = 0; i < 3 && !creditsLoaded; i++) {
                  try {
                      const credits = await AuthService.getUserCredits();
                      if (elements.creditsDisplay) {
                          elements.creditsDisplay.textContent = `Credits: ${credits}`;
                          console.log('💰 Credits loaded:', credits);
                          creditsLoaded = true;
                      }
                  } catch (error) {
                      console.warn(`⚠️ Credits load attempt ${i + 1} failed:`, error.message);
                      if (i === 2) {
                          if (elements.creditsDisplay) {
                              elements.creditsDisplay.textContent = 'Credits: --';
                          }
                      } else {
                          await new Promise(resolve => setTimeout(resolve, 1000));
                      }
                  }
              }
              
              // Initialize UI component renderer
              if (typeof UIComponentRenderer !== 'undefined') {
                  uiRenderer = UIComponentRenderer.init({
                      linkHandler: (url) => {
                          try {
                              window.open(url, '_blank', 'noopener,noreferrer');
                          } catch (error) {
                              console.error('Failed to open link:', error);
                          }
                      },
                      actionHandler: (action, value) => {
                          if (action === 'reply' && value) {
                              elements.messageInput.value = value;
                              setTimeout(() => sendMessage(), 100);
                          }
                      }
                  });
                  console.log('✅ UI renderer initialized');
              } else {
                  console.warn('⚠️ UIComponentRenderer not available');
              }
              
              console.log('✅ UI initialized successfully');
              
          } catch (error) {
              console.error('❌ UI initialization error:', error);
              throw error;
          }
      }
      
      /**
      * Enhanced chat service initialization
      */
      async function initializeChatService() {
          console.log('💬 COMPREHENSIVE: Initializing enhanced chat service...');
          
          if (!window.AAAI_CONFIG.ENABLE_WEBSOCKETS || typeof ChatService === 'undefined') {
              console.log('⚠️ WebSocket chat disabled or unavailable, using HTTP mode');
              updateConnectionStatus('disconnected');
              showStatusIndicator('disconnected', '📡 HTTP mode only');
              return;
          }
          
          try {
              // Enhanced pre-connection validation
              console.log('🔍 COMPREHENSIVE: Enhanced pre-connection validation...');
              
              const user = AuthService.getCurrentUser();
              if (!user || !user.id || !user.email) {
                  throw new Error('User information not available for WebSocket');
              }
              
              // Validate authentication state
              const sessionInfo = AuthService.getSessionInfo();
              console.log('🔍 Session validation:', {
                  authenticated: sessionInfo.authenticated,
                  tokenValid: sessionInfo.tokenValid,
                  hasRefreshToken: sessionInfo.hasRefreshToken,
                  cookieHealth: sessionInfo.cookieHealth
              });
              
              // Ensure we have proper authentication cookies
              const hasAuthCookie = getCookie('authenticated') === 'true';
              const hasUserInfo = !!getCookie('user_info');
              
              console.log('🍪 Cookie validation:', {
                  authenticated: hasAuthCookie,
                  userInfo: hasUserInfo
              });
              
              // If missing essential cookies, try to refresh
              if (!hasAuthCookie || !hasUserInfo) {
                  console.log('🔄 Missing essential cookies, attempting refresh...');
                  try {
                      await AuthService.refreshTokenIfNeeded();
                      await new Promise(resolve => setTimeout(resolve, 1000));
                      
                      const newHasAuthCookie = getCookie('authenticated') === 'true';
                      const newHasUserInfo = !!getCookie('user_info');
                      
                      console.log('🍪 Post-refresh cookies:', {
                          authenticated: newHasAuthCookie,
                          userInfo: newHasUserInfo
                      });
                      
                  } catch (refreshError) {
                      console.warn('⚠️ Cookie refresh failed:', refreshError.message);
                  }
              }
              
              // Initialize ChatService with enhanced configuration
              console.log('🚀 Initializing ChatService with enhanced options...');
              
              chatService = ChatService.init(AuthService, {
                  reconnectInterval: 3000,
                  maxReconnectAttempts: maxConnectionRetries,
                  heartbeatInterval: 45000,
                  connectionTimeout: 15000,
                  authTimeout: 8000,
                  socketReadyTimeout: 4000,
                  preAuthDelay: 500,
                  messageQueueLimit: 25,
                  debug: window.AAAI_CONFIG.ENABLE_DEBUG || false,
                  useFallbackAuth: true,
                  maxConnectionAge: 7200000 // 2 hours
              });
              
              // Setup enhanced event listeners
              chatService.onMessage(handleChatMessage);
              chatService.onStatusChange(handleConnectionStatus);
              chatService.onError(handleChatError);
              
              // Enhanced authentication-specific listeners
              chatService.onAuthSuccess((data) => {
                  console.log('🔐 COMPREHENSIVE: WebSocket authentication successful');
                  connectionRetryCount = 0; // Reset retry count on success
                  showStatusIndicator('connected', '✅ Connected & Authenticated');
                  
                  if (elements.connectionError) {
                      elements.connectionError.style.display = 'none';
                  }
              });
              
              chatService.onAuthError((data) => {
                  console.error('🔐 COMPREHENSIVE: WebSocket authentication failed:', data);
                  showStatusIndicator('disconnected', '🔑 Authentication failed');
                  showConnectionError('Authentication failed. Please refresh the page.');
              });
              
              console.log('✅ COMPREHENSIVE: ChatService initialized with enhanced options');
              
              // Attempt connection with retry logic
              await attemptConnectionWithRetry();
              
          } catch (error) {
              console.error('❌ COMPREHENSIVE: Failed to initialize ChatService:', error);
              updateConnectionStatus('disconnected');
              showStatusIndicator('disconnected', '❌ Initialization failed');
              showConnectionError('Failed to initialize chat service. Please refresh the page.');
          }
      }
      
      /**
      * Enhanced connection attempt with retry logic
      */
      async function attemptConnectionWithRetry() {
          console.log('🔗 COMPREHENSIVE: Attempting WebSocket connection...');
          
          try {
              updateConnectionStatus('connecting');
              showStatusIndicator('connecting', '🔄 Connecting...');
              
              const connected = await chatService.connect();
              
              if (connected) {
                  console.log('✅ COMPREHENSIVE: WebSocket connected successfully');
                  connectionRetryCount = 0;
                  updateConnectionStatus('connected');
                  showStatusIndicator('connected', '✅ Connected via WebSocket');
              } else {
                  throw new Error('Connection returned false');
              }
              
          } catch (error) {
              connectionRetryCount++;
              console.error(`❌ COMPREHENSIVE: Connection attempt ${connectionRetryCount} failed:`, error.message);
              
              updateConnectionStatus('disconnected');
              
              // Enhanced error classification
              let errorMessage = 'Connection failed';
              let shouldRetry = connectionRetryCount < maxConnectionRetries;
              
              if (error.message.includes('Authentication')) {
                  errorMessage = 'Authentication failed - please refresh the page';
                  shouldRetry = false;
                  showStatusIndicator('disconnected', '🔑 Authentication failed');
              } else if (error.message.includes('timeout')) {
                  errorMessage = 'Connection timeout - check your internet connection';
                  showStatusIndicator('disconnected', '⏰ Connection timeout');
              } else if (error.message.includes('expired')) {
                  errorMessage = 'Session expired - please refresh the page';
                  shouldRetry = false;
                  showStatusIndicator('disconnected', '🔑 Session expired');
              } else {
                  showStatusIndicator('disconnected', '📡 Using HTTP mode');
              }
              
              if (shouldRetry) {
                  const delay = Math.min(connectionRetryCount * 2000, 10000);
                  console.log(`🔄 Retrying connection in ${delay}ms (attempt ${connectionRetryCount}/${maxConnectionRetries})`);
                  
                  showStatusIndicator('reconnecting', `🔄 Retrying in ${Math.round(delay/1000)}s...`);
                  
                  setTimeout(async () => {
                      try {
                          await attemptConnectionWithRetry();
                      } catch (retryError) {
                          console.error('Retry failed:', retryError);
                      }
                  }, delay);
              } else {
                  console.log('❌ Max connection attempts reached or authentication failed');
                  showConnectionError(errorMessage);
                  showStatusIndicator('disconnected', '📡 Using HTTP mode');
              }
          }
      }
      
      /**
      * Enhanced project data loading
      */
      async function loadProjectData(projectId) {
          console.log('📋 Loading enhanced project data for:', projectId);
          
          try {
              // Try to load project from API first
              let project = null;
              
              try {
                  // Attempt to get project details from API
                  const result = await AuthService.executeFunction('get_project_details', {
                      project_id: projectId
                  });
                  
                  if (result && result.data && result.data.success) {
                      project = result.data.project;
                      console.log('✅ Project loaded from API:', project.name);
                  }
              } catch (apiError) {
                  console.warn('⚠️ Failed to load project from API:', apiError.message);
              }
              
              // Fallback to mock data if API fails
              if (!project) {
                  console.log('📋 Using fallback project data');
                  const mockProjects = {
                      '1': {
                          id: '1',
                          name: 'Marketing Campaign Analysis',
                          description: 'AI-driven insights for Q4 marketing campaigns and customer engagement strategies'
                      },
                      '2': {
                          id: '2',
                          name: 'Product Development Ideas',
                          description: 'Brainstorming and planning for new product features and improvements'
                      },
                      '3': {
                          id: '3',
                          name: 'Customer Support Optimization',
                          description: 'Improving response times and customer satisfaction through AI assistance'
                      }
                  };
                  
                  project = mockProjects[projectId] || {
                      id: projectId,
                      name: 'AI Assistant Project',
                      description: 'Intelligent conversation assistant for your needs'
                  };
              }
              
              currentProject = project;
              
              // Update UI
              if (elements.projectTitle) {
                  elements.projectTitle.textContent = project.name;
              }
              if (elements.projectSubtitle) {
                  elements.projectSubtitle.textContent = project.description;
              }
              
              // Update page title
              document.title = `${project.name} - AAAI Solutions`;
              
              // Add environment info to chat header
              const chatEnvInfo = document.getElementById('chatEnvInfo');
              if (chatEnvInfo) {
                  const env = window.AAAI_CONFIG.ENVIRONMENT;
                  const version = window.AAAI_CONFIG.VERSION || '2.0';
                  if (env !== 'production') {
                      chatEnvInfo.textContent = `${env.toUpperCase()} v${version}`;
                  }
              }
              
              console.log('✅ Project loaded and UI updated:', project.name);
              
          } catch (error) {
              console.error('❌ Failed to load project data:', error);
              
              if (elements.projectTitle) {
                  elements.projectTitle.textContent = 'Project Error';
              }
              if (elements.projectSubtitle) {
                  elements.projectSubtitle.textContent = 'Failed to load project information';
              }
              
              showError('Failed to load project information. Some features may not work properly.');
          }
      }
      
      /**
      * Enhanced event listener setup
      */
      function setupEventListeners() {
          console.log('🎯 Setting up enhanced event listeners...');
          
          try {
              // Back button
              if (elements.backBtn) {
                  elements.backBtn.addEventListener('click', () => {
                      console.log('🔙 Navigating back to projects');
                      window.location.href = 'project.html';
                  });
              }
              
              // Send message button
              if (elements.sendMessageBtn) {
                  elements.sendMessageBtn.addEventListener('click', sendMessage);
              }
              
              // Enhanced message input handling
              if (elements.messageInput) {
                  elements.messageInput.addEventListener('keydown', function(e) {
                      if (e.key === 'Enter' && !e.shiftKey) {
                          e.preventDefault();
                          sendMessage();
                      }
                  });
                  
                  // Auto-resize textarea with limits
                  elements.messageInput.addEventListener('input', function() {
                      this.style.height = 'auto';
                      const newHeight = Math.min(this.scrollHeight, 120);
                      this.style.height = newHeight + 'px';
                      
                      // Character count warning
                      const length = this.value.length;
                      if (length > 3500) {
                          this.style.borderColor = '#e74c3c';
                          if (length > 4000) {
                              this.value = this.value.substring(0, 4000);
                              showError('Message too long. Maximum 4000 characters allowed.');
                          }
                      } else {
                          this.style.borderColor = '';
                      }
                  });
              }
              
              // Reconnect button
              if (elements.reconnectBtn) {
                  elements.reconnectBtn.addEventListener('click', async () => {
                      console.log('🔄 Manual reconnect requested');
                      connectionRetryCount = 0; // Reset retry count
                      
                      if (elements.connectionError) {
                          elements.connectionError.style.display = 'none';
                      }
                      
                      if (chatService) {
                          try {
                              await chatService.forceReconnect();
                          } catch (error) {
                              console.error('Manual reconnect failed:', error);
                              showError('Reconnection failed. Please refresh the page.');
                          }
                      } else {
                          // Reinitialize chat service
                          await initializeChatService();
                      }
                  });
              }
              
              // Page visibility change handling
              document.addEventListener('visibilitychange', () => {
                  if (document.visibilityState === 'visible') {
                      console.log('👀 Page became visible');
                      
                      // Check authentication
                      if (!AuthService.isAuthenticated()) {
                          console.log('❌ Authentication lost while page was hidden');
                          redirectToLogin('Session expired while page was hidden');
                          return;
                      }
                      
                      // Check WebSocket connection
                      if (chatService) {
                          const status = chatService.getStatus();
                          if (!status.connected && !status.connecting) {
                              console.log('🔄 Attempting to reconnect after page visibility change');
                              setTimeout(() => {
                                  attemptConnectionWithRetry().catch(console.error);
                              }, 1000);
                          }
                      }
                  }
              });
              
              // Enhanced error handling for unhandled promise rejections
              window.addEventListener('unhandledrejection', (event) => {
                  console.error('🚨 Unhandled promise rejection:', event.reason);
                  
                  // Check if it's an authentication error
                  if (event.reason && event.reason.message && event.reason.message.includes('Authentication')) {
                      console.log('🔑 Unhandled authentication error detected');
                      showError('Authentication error detected. Please refresh the page.');
                  }
                  
                  // Prevent the default behavior (which would log the error to console)
                  event.preventDefault();
              });
              
              console.log('✅ Enhanced event listeners setup complete');
              
          } catch (error) {
              console.error('❌ Error setting up event listeners:', error);
          }
      }
      
      /**
      * Enhanced message sending
      */
      async function sendMessage() {
          const messageText = elements.messageInput.value.trim();
          if (!messageText || elements.sendMessageBtn.disabled) return;
          
          console.log('📤 COMPREHENSIVE: Sending enhanced message:', messageText.substring(0, 50) + (messageText.length > 50 ? '...' : ''));
          
          // Clear input and disable button
          elements.messageInput.value = '';
          elements.messageInput.style.height = 'auto';
          elements.sendMessageBtn.disabled = true;
          
          // Hide welcome message
          hideWelcomeMessage();
          
          // Add user message to chat
          const userMessage = addMessageToChat(messageText, 'user');
          
          try {
              // Enhanced message sending logic
              const useWebSocket = chatService && chatService.getStatus().authenticated;
              
              if (useWebSocket) {
                  console.log('🌐 COMPREHENSIVE: Sending via WebSocket');
                  try {
                      const messageId = await chatService.sendMessage(messageText);
                      console.log('✅ WebSocket message sent, ID:', messageId);
                      showTypingIndicator();
                  } catch (wsError) {
                      console.log('🔄 WebSocket send failed, falling back to HTTP:', wsError.message);
                      await sendMessageHTTP(messageText, userMessage);
                  }
              } else {
                  console.log('📡 COMPREHENSIVE: Sending via HTTP');
                  await sendMessageHTTP(messageText, userMessage);
              }
              
          } catch (error) {
              console.error('❌ COMPREHENSIVE: Failed to send message:', error);
              
              // Remove user message if send completely failed
              if (userMessage) {
                  userMessage.remove();
              }
              
              // Re-enable input and restore message
              elements.messageInput.value = messageText;
              elements.sendMessageBtn.disabled = false;
              elements.messageInput.focus();
              
              // Show appropriate error message
              let errorMessage = 'Failed to send message. Please try again.';
              if (error.message.includes('Authentication') || error.message.includes('expired')) {
                  errorMessage = 'Your session has expired. Please refresh the page.';
              }
              
              showError(errorMessage);
          }
      }
      
      /**
      * Enhanced HTTP message sending
      */
      async function sendMessageHTTP(messageText, userMessageElement) {
          const typingIndicator = showTypingIndicator();
          
          try {
              console.log('📡 COMPREHENSIVE: Sending HTTP request...');
              const response = await AuthService.sendChatMessage(messageText);
              
              if (typingIndicator) {
                  typingIndicator.remove();
              }
              
              if (response && response.data && response.data.bot_message) {
                  addMessageToChat(
                      response.data.bot_message.text,
                      'bot',
                      response.data.bot_message.timestamp,
                      response.data.bot_message.components
                  );
              } else if (response && response.status === 'queued') {
                  // Message was queued, show appropriate feedback
                  addMessageToChat(
                      'Your message has been received and is being processed. The response will appear shortly.',
                      'bot',
                      null,
                      null,
                      'queued'
                  );
              }
              
              elements.sendMessageBtn.disabled = false;
              elements.messageInput.focus();
              
              console.log('✅ COMPREHENSIVE: HTTP message sent successfully');
              
          } catch (error) {
              console.error('❌ COMPREHENSIVE: HTTP message failed:', error);
              
              if (typingIndicator) {
                  typingIndicator.remove();
              }
              
              if (userMessageElement) {
                  userMessageElement.remove();
              }
              
              let errorMessage = 'Sorry, I encountered an error. Please try again.';
              if (error.message.includes('expired')) {
                  errorMessage = 'Your session has expired. Please refresh the page.';
                  showError('Session expired. Please refresh the page.');
              } else if (error.message.includes('Authentication')) {
                  errorMessage = 'Authentication error. Please refresh the page.';
                  showError('Authentication error. Please refresh the page.');
              }
              
              addMessageToChat(errorMessage, 'bot');
              
              elements.sendMessageBtn.disabled = false;
              elements.messageInput.focus();
              
              throw error;
          }
      }
      
      /**
      * Enhanced message handling
      */
      function handleChatMessage(data) {
          console.log('📨 COMPREHENSIVE: Received enhanced message:', data.type);
          
          switch (data.type) {
              case 'connection_established':
              case 'authenticated':
                  window.AAAI_LOGGER?.info('COMPREHENSIVE: WebSocket authenticated');
                  console.log('🔐 COMPREHENSIVE: WebSocket authenticated successfully');
                  showStatusIndicator('connected', '✓ Connected & Authenticated');
                  break;
                  
              case 'welcome':
                  console.log('👋 Received welcome message');
                  if (data.message) {
                      addMessageToChat(data.message, 'bot', data.timestamp);
                  }
                  break;
                  
              case 'message':
                  const typingIndicator = elements.chatBody.querySelector('.typing-indicator');
                  if (typingIndicator) {
                      typingIndicator.remove();
                  }
                  
                  if (data.bot_message) {
                      addMessageToChat(
                          data.bot_message.text,
                          'bot',
                          data.bot_message.timestamp,
                          data.bot_message.components
                      );
                  }
                  
                  elements.sendMessageBtn.disabled = false;
                  elements.messageInput.focus();
                  break;
                  
              case 'message_queued':
                  console.log('📥 Message queued for processing:', data.message_id);
                  // Show queued status without removing typing indicator yet
                  break;
                  
              case 'history_loaded':
                  console.log('📚 Message history loaded:', data.messages?.length || 0, 'messages');
                  if (data.messages && data.messages.length > 0) {
                      loadMessageHistory(data.messages);
                  }
                  break;
                  
              case 'error':
                  console.error('💬 COMPREHENSIVE: Chat error:', data.message);
                  
                  const errorTypingIndicator = elements.chatBody.querySelector('.typing-indicator');
                  if (errorTypingIndicator) {
                      errorTypingIndicator.remove();
                  }
                  
                  let errorMessage = 'An error occurred. Please try again.';
                  if (data.message && data.message.includes('Authentication')) {
                      errorMessage = 'Authentication error. Please refresh the page.';
                      showError('Session expired. Please refresh the page.');
                  } else if (data.message && data.message.includes('expired')) {
                      errorMessage = 'Your session has expired. Please refresh the page.';
                      showError('Session expired. Please refresh the page.');
                  } else if (data.message) {
                      errorMessage = data.message;
                  }
                  
                  addMessageToChat(errorMessage, 'bot');
                  
                  elements.sendMessageBtn.disabled = false;
                  elements.messageInput.focus();
                  break;
                  
              case 'auth_warning':
                  console.warn('⚠️ Authentication warning:', data.message);
                  if (data.severity === 'warning') {
                      showError(data.message || 'Please refresh your session soon.');
                  }
                  break;
                  
              case 'disconnect_notice':
                  console.log('🔌 Disconnect notice:', data.message);
                  showStatusIndicator('disconnected', '🔄 Reconnecting...');
                  break;
                  
              case 'ping':
                  // Handle ping silently
                  break;
                  
              default:
                  console.log('🔍 COMPREHENSIVE: Unknown message type:', data.type);
                  break;
          }
      }
      
      /**
      * Enhanced connection status handling
      */
      function handleConnectionStatus(status) {
          console.log('🔄 COMPREHENSIVE: Connection status changed:', status);
          updateConnectionStatus(status);
          
          switch (status) {
              case 'connected':
                  if (chatService && chatService.getStatus().authenticated) {
                      showStatusIndicator('connected', '✓ Connected via WebSocket');
                      if (elements.connectionError) {
                          elements.connectionError.style.display = 'none';
                      }
                  } else {
                      showStatusIndicator('connecting', '🔐 Authenticating...');
                  }
                  break;
              case 'connecting':
                  showStatusIndicator('connecting', '⚡ Connecting...');
                  break;
              case 'reconnecting':
                  showStatusIndicator('reconnecting', '🔄 Reconnecting...');
                  break;
              case 'disconnected':
                  const authStatus = AuthService.isAuthenticated();
                  if (!authStatus) {
                      showStatusIndicator('disconnected', '🔑 Please log in');
                  } else {
                      showStatusIndicator('disconnected', '📡 Using HTTP mode');
                  }
                  break;
              case 'error':
                  showStatusIndicator('disconnected', '⚠️ Connection error');
                  break;
              case 'failed':
                  showStatusIndicator('disconnected', '❌ Connection failed');
                  showConnectionError('Connection failed. Please check your internet connection.');
                  break;
              case 'offline':
                  showStatusIndicator('disconnected', '📴 Offline');
                  break;
          }
      }
      
      /**
      * Enhanced error handling
      */
      function handleChatError(data) {
          console.error('💥 COMPREHENSIVE: Chat service error:', data);
          
          if (data.requiresLogin || data.requiresPageRefresh || (data.error && data.error.includes('Session expired'))) {
              console.log('🔑 COMPREHENSIVE: Authentication error detected');
              showError('Your session has expired. Please refresh the page to reconnect.');
              showConnectionError('Session expired. Please refresh the page.');
              
              // Auto-refresh after delay
              setTimeout(() => {
                  if (confirm('Your session has expired. Click OK to refresh the page.')) {
                      window.location.reload();
                  }
              }, 5000);
              
          } else if (data.error && data.error.includes('timeout')) {
              console.log('⏰ COMPREHENSIVE: Timeout error');
              showStatusIndicator('disconnected', '⏰ Connection timeout');
              showConnectionError('Connection timeout. Please check your internet connection.');
              
          } else {
              console.log('🔄 COMPREHENSIVE: General error, will retry');
              showStatusIndicator('disconnected', '⚠️ Connection error');
              
              if (data.retry_recommended) {
                  showConnectionError('Connection error. Click reconnect to try again.');
              }
          }
      }
      
      // Keep all existing utility functions but enhance them...
      
      /**
      * Enhanced message display
      */
      function addMessageToChat(text, type, timestamp = null, components = null, messageStatus = null) {
          hideWelcomeMessage();
          
          const messageDiv = document.createElement('div');
          messageDiv.className = type === 'user' ? 'message message-user' : 'message message-bot';
          
          // Message text
          const textDiv = document.createElement('div');
          textDiv.textContent = text;
          messageDiv.appendChild(textDiv);
          
          // Enhanced timestamp
          const timestampDiv = document.createElement('div');
          timestampDiv.className = 'message-timestamp';
          const date = timestamp ? new Date(timestamp) : new Date();
          timestampDiv.textContent = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
          messageDiv.appendChild(timestampDiv);
          
          // Message status for queued messages
          if (messageStatus) {
              const statusDiv = document.createElement('div');
              statusDiv.className = 'message-status';
              statusDiv.textContent = messageStatus === 'queued' ? 'Processing...' : messageStatus;
              messageDiv.appendChild(statusDiv);
          }
          
          // UI components
          if (type === 'bot' && components && components.length > 0 && uiRenderer) {
              const componentsContainer = document.createElement('div');
              componentsContainer.className = 'chat-components-container';
              
              components.forEach(component => {
                  try {
                      uiRenderer.renderComponent(component, componentsContainer);
                  } catch (componentError) {
                      console.error('Error rendering component:', componentError);
                  }
              });
              
              messageDiv.appendChild(componentsContainer);
          }
          
          elements.chatBody.appendChild(messageDiv);
          elements.chatBody.scrollTop = elements.chatBody.scrollHeight;
          
          return messageDiv;
      }
      
      /**
      * Enhanced connection status display
      */
      function updateConnectionStatus(status) {
          if (!elements.connectionDot || !elements.connectionText) return;
          
          elements.connectionDot.className = 'connection-dot';
          
          switch (status) {
              case 'connected':
                  if (chatService && chatService.getStatus().authenticated) {
                      elements.connectionDot.classList.add('connected');
                      elements.connectionText.textContent = 'WebSocket';
                  } else {
                      elements.connectionDot.classList.add('connecting');
                      elements.connectionText.textContent = 'Authenticating...';
                  }
                  break;
              case 'connecting':
              case 'reconnecting':
                  elements.connectionDot.classList.add('connecting');
                  elements.connectionText.textContent = status === 'connecting' ? 'Connecting...' : 'Reconnecting...';
                  break;
              case 'offline':
                  elements.connectionText.textContent = 'Offline';
                  break;
              default:
                  elements.connectionText.textContent = 'HTTP Mode';
                  elements.connectionDot.classList.add('connecting');
                  break;
          }
      }
      
      /**
      * Enhanced error display
      */
      function showError(message, duration = 5000) {
          console.error('🚨 COMPREHENSIVE: Error:', message);
          
          const errorDiv = document.createElement('div');
          errorDiv.style.cssText = `
              position: fixed;
              top: 120px;
              left: 50%;
              transform: translateX(-50%);
              background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
              color: white;
              padding: 15px 25px;
              border-radius: 10px;
              z-index: 10000;
              font-weight: 500;
              box-shadow: 0 5px 15px rgba(231, 76, 60, 0.3);
              max-width: 400px;
              text-align: center;
              animation: slideInDown 0.3s ease-out;
          `;
          errorDiv.textContent = message;
          document.body.appendChild(errorDiv);
          
          setTimeout(() => {
              errorDiv.style.animation = 'slideOutUp 0.3s ease-in';
              setTimeout(() => {
                  if (errorDiv.parentNode) {
                      errorDiv.remove();
                  }
              }, 300);
          }, duration);
      }
      
      /**
      * Show connection error panel
      */
      function showConnectionError(message) {
          if (elements.connectionError) {
              elements.connectionError.style.display = 'block';
              const errorText = elements.connectionError.querySelector('p');
              if (errorText) {
                  errorText.textContent = message;
              }
          }
      }
      
      // Add CSS animations
      const style = document.createElement('style');
      style.textContent = `
          @keyframes slideInDown {
              from { transform: translateX(-50%) translateY(-100%); opacity: 0; }
              to { transform: translateX(-50%) translateY(0); opacity: 1; }
          }
          @keyframes slideOutUp {
              from { transform: translateX(-50%) translateY(0); opacity: 1; }
              to { transform: translateX(-50%) translateY(-100%); opacity: 0; }
          }
      `;
      document.head.appendChild(style);
      
      // Keep all other utility functions...
      function showTypingIndicator() {
          // Remove existing typing indicator
          const existing = elements.chatBody.querySelector('.typing-indicator');
          if (existing) existing.remove();
          
          const typingDiv = document.createElement('div');
          typingDiv.className = 'typing-indicator';
          typingDiv.innerHTML = '<span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span>';
          
          elements.chatBody.appendChild(typingDiv);
          elements.chatBody.scrollTop = elements.chatBody.scrollHeight;
          
          return typingDiv;
      }
      
      function hideWelcomeMessage() {
          if (elements.welcomeMessage && elements.welcomeMessage.style.display !== 'none') {
              elements.welcomeMessage.style.display = 'none';
          }
      }
      
      function showStatusIndicator(status, message = null) {
          // Hide all indicators
          [elements.connectedStatus, elements.disconnectedStatus, elements.reconnectingStatus].forEach(el => {
              if (el) el.classList.remove('visible');
          });
          
          let indicator = null;
          let defaultMessage = '';
          
          switch (status) {
              case 'connected':
                  indicator = elements.connectedStatus;
                  defaultMessage = '✅ Connected';
                  break;
              case 'disconnected':
              case 'error':
                  indicator = elements.disconnectedStatus;
                  defaultMessage = '📡 HTTP Mode';
                  break;
              case 'connecting':
              case 'reconnecting':
                  indicator = elements.reconnectingStatus;
                  defaultMessage = '🔄 Connecting...';
                  break;
          }
          
          if (indicator) {
              indicator.textContent = message || defaultMessage;
              indicator.classList.add('visible');
              
              // Auto-hide connected status after 3 seconds
              if (status === 'connected') {
                  setTimeout(() => {
                      indicator.classList.remove('visible');
                  }, 3000);
              }
          }
      }
      
      function startAuthMonitoring() {
          // Check authentication every 30 seconds
          authCheckInterval = setInterval(() => {
              if (!AuthService.isAuthenticated()) {
                  console.log('⚠️ Authentication lost during monitoring');
                  clearInterval(authCheckInterval);
                  redirectToLogin('Authentication lost');
              }
          }, 30000);
      }
      
      function getProjectId() {
          const urlParams = new URLSearchParams(window.location.search);
          return urlParams.get('project');
      }
      
      function redirectToLogin(reason = 'Authentication required') {
          console.log('🔑 Redirecting to login:', reason);
          window.location.href = 'login.html';
      }
      
      function redirectToProjects() {
          console.log('📁 Redirecting to projects');
          window.location.href = 'project.html';
      }
      
      function getCookie(name) {
          try {
              const value = `; ${document.cookie}`;
              const parts = value.split(`; ${name}=`);
              if (parts.length === 2) {
                  const cookieValue = parts.pop().split(';').shift();
                  return decodeURIComponent(cookieValue);
              }
          } catch (error) {
              console.warn(`Error reading cookie ${name}:`, error);
          }
          return null;
      }
      
      function loadMessageHistory(messages) {
          // Show message history header
          const historyHeader = document.getElementById('historyHeader');
          if (historyHeader && messages.length > 0) {
              historyHeader.style.display = 'flex';
          }
          
          // Add messages to chat (in reverse order since they come newest first)
          messages.reverse().forEach(msg => {
              if (msg.sender === 'user') {
                  addMessageToChat(msg.text, 'user', msg.timestamp);
              } else if (msg.sender === 'bot') {
                  addMessageToChat(msg.text, 'bot', msg.timestamp, msg.components);
              }
          });
          
          console.log('📚 Message history loaded:', messages.length, 'messages');
      }
      
      /**
      * Global function for suggestion buttons
      */
      window.sendSuggestion = function(suggestion) {
          console.log('💡 Sending suggestion:', suggestion);
          if (elements.messageInput) {
              elements.messageInput.value = suggestion;
              sendMessage();
          }
      };
      
      // Cleanup on page unload
      window.addEventListener('beforeunload', () => {
          if (authCheckInterval) {
              clearInterval(authCheckInterval);
          }
          if (chatService) {
              chatService.disconnect();
          }
      });
      
      // Initialize the enhanced application
      initializeApp();
  });
  </script>
  <script>
    (function() {
      'use strict';
      
      console.log('🔍 FIXED: Simple WebSocket Debug Script Loaded');
      
      // Track WebSocket lifecycle events without interfering
      const wsEvents = [];
      let wsConnectionStartTime = null;
      
      // FIXED: Override WebSocket to track but not modify
      const originalWebSocket = window.WebSocket;
      window.WebSocket = function(url, protocols) {
          // FIXED: Don't add any query parameters - use clean URL
          console.log('🔌 FIXED: Creating clean WebSocket:', url);
          wsConnectionStartTime = Date.now();
          
          const ws = new originalWebSocket(url, protocols);
          
          // Track events without modification
          ['open', 'message', 'close', 'error'].forEach(eventType => {
              ws.addEventListener(eventType, function(event) {
                  const eventTime = Date.now();
                  const elapsed = wsConnectionStartTime ? eventTime - wsConnectionStartTime : 0;
                  
                  const eventData = {
                      type: eventType,
                      timestamp: new Date().toISOString(),
                      elapsed: elapsed,
                      readyState: ws.readyState,
                      code: event.code,
                      reason: event.reason
                  };
                  
                  wsEvents.push(eventData);
                  
                  // Enhanced logging
                  if (eventType === 'open') {
                      console.log(`✅ FIXED: WebSocket OPENED in ${elapsed}ms`);
                      console.log(`   ReadyState: ${ws.readyState} (${getReadyStateName(ws.readyState)})`);
                  } else if (eventType === 'close') {
                      console.log(`🔌 FIXED: WebSocket CLOSED: Code ${event.code} - ${event.reason || 'No reason'}`);
                      console.log(`   Total connection time: ${elapsed}ms`);
                  } else if (eventType === 'error') {
                      console.error(`❌ FIXED: WebSocket ERROR after ${elapsed}ms:`, event);
                  } else if (eventType === 'message') {
                      try {
                          const data = JSON.parse(event.data);
                          if (data.type === 'auth_success' || data.type === 'authenticated' || data.type === 'connection_established') {
                              console.log(`🔐 FIXED: Authentication SUCCESS after ${elapsed}ms`);
                          } else if (data.type === 'auth_error' || data.type === 'authentication_failed') {
                              console.error(`🔐 FIXED: Authentication FAILED after ${elapsed}ms:`, data);
                          } else {
                              console.log(`📨 FIXED: Message received (${data.type}) after ${elapsed}ms`);
                          }
                      } catch (e) {
                          console.log(`📨 FIXED: Non-JSON message received after ${elapsed}ms`);
                      }
                  }
              });
          });
          
          // Track outgoing messages without modification
          const originalSend = ws.send;
          ws.send = function(data) {
              try {
                  const parsed = JSON.parse(data);
                  const elapsed = wsConnectionStartTime ? Date.now() - wsConnectionStartTime : 0;
                  console.log(`📤 FIXED: Sending message (${parsed.type}) after ${elapsed}ms`);
              } catch (e) {
                  console.log(`📤 FIXED: Sending raw data after ${Date.now() - wsConnectionStartTime}ms`);
              }
              
              return originalSend.call(this, data);
          };
          
          return ws;
      };
      
      function getReadyStateName(readyState) {
          const states = {
              0: 'CONNECTING',
              1: 'OPEN', 
              2: 'CLOSING',
              3: 'CLOSED'
          };
          return states[readyState] || 'UNKNOWN';
      }
      
      // FIXED: Debug functions
      window.debugWebSocket = function() {
          console.log('🔍 === FIXED WebSocket Debug Information ===');
          
          if (typeof AuthService !== 'undefined') {
              const sessionInfo = AuthService.getSessionInfo();
              console.log('🔑 Auth Status:', {
                  authenticated: sessionInfo.authenticated,
                  userId: sessionInfo.userId,
                  email: sessionInfo.email,
                  tokenValid: sessionInfo.tokenValid,
                  hasRefreshToken: sessionInfo.hasRefreshToken
              });
          }
          
          if (typeof ChatService !== 'undefined' && ChatService.getStatus) {
              console.log('💬 Chat Service Status:', ChatService.getStatus());
          }
          
          console.log('📊 WebSocket Events (' + wsEvents.length + ' total):');
          wsEvents.slice(-10).forEach((event, index) => {
              console.log(`  ${index + 1}. [${event.elapsed}ms] ${event.type.toUpperCase()}`, {
                  readyState: event.readyState,
                  code: event.code,
                  reason: event.reason
              });
          });
          
          console.log('🔍 === End FIXED Debug Information ===');
      };
      
      // Auto-run debug info after page load
      setTimeout(() => {
          if (typeof window.debugWebSocket === 'function') {
              console.log('🔍 FIXED: Auto-running WebSocket debug...');
              window.debugWebSocket();
          }
      }, 3000);
      
      console.log('🔍 FIXED debug loaded. Use debugWebSocket() in console.');
    })();
  </script>
</body>

</html>