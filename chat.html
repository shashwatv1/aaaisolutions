<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AAAI Solutions - AI Chat</title>
  <link rel="shortcut icon" href="./robot.svg" type="image/svg+xml">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  
  <!-- Optimized font loading with display swap -->
  <link href="https://fonts.googleapis.com/css2?family=Barlow:wght@600;700&family=Open+Sans:wght@400;500;700&family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  
  <!-- Critical CSS for above-the-fold content -->
  <style>
    /* Critical inline styles for fast initial render */
    :root {
      --primary-gradient: linear-gradient(135deg, #4338ca 0%, #3730a3 100%);
      --card-gradient: linear-gradient(135deg, #1e293b 0%, #334155 100%);
      --success-color: #2ecc71;
      --error-color: #e74c3c;
      --warning-color: #f39c12;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: 'Open Sans', sans-serif;
      background: linear-gradient(180deg, #0f172a 0%, #1e293b 100%);
      color: white;
      overflow-x: hidden;
    }

    .main-content {
      min-height: 100vh;
      padding-top: 80px;
    }

    /* Environment indicator - critical for immediate visibility */
    .env-indicator {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      z-index: 10000;
      padding: 5px 10px;
      text-align: center;
      font-size: 0.8rem;
      font-weight: bold;
      color: white;
      display: none;
    }
    
    .env-indicator.development {
      background-color: #f39c12;
      display: block;
    }
    
    .env-indicator.staging {
      background-color: #9b59b6;
      display: block;
    }
    
    body.with-env-indicator {
      padding-top: 30px;
    }

    /* Critical layout styles */
    .chat-layout {
      margin: 20px auto !important;
      display: flex !important;
      flex-direction: row !important;
      height: calc(100vh - 140px) !important;
      gap: 0 !important;
      position: relative !important;
      width: 100% !important;
      max-width: 1400px !important;
      padding: 0 20px !important;
      box-sizing: border-box !important;
      align-items: stretch !important;
    }

    .chat-sidebar {
      width: 300px !important;
      min-width: 300px !important;
      max-width: 300px !important;
      background: var(--card-gradient) !important;
      border-radius: 15px 0 0 15px !important;
      border: 1px solid rgba(255, 255, 255, 0.1) !important;
      border-right: none !important;
      display: flex !important;
      flex-direction: column !important;
      transition: all 0.3s ease !important;
      overflow: hidden !important;
      flex-shrink: 0 !important;
    }

    .chat-container {
      flex: 1 !important;
      min-width: 0 !important;
      background-color: #1e293b !important;
      border-radius: 0 15px 15px 0 !important;
      overflow: hidden !important;
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3) !important;
      border: 1px solid rgba(255, 255, 255, 0.1) !important;
      border-left: none !important;
      display: flex !important;
      flex-direction: column !important;
    }

    /* Loading spinner for initial load */
    .initial-loading {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 9999;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-top: 3px solid #ff7e5f;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading-text {
      color: rgba(255, 255, 255, 0.8);
      font-size: 1.1rem;
      font-weight: 600;
    }

    /* Hide content until loaded */
    .chat-layout {
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .chat-layout.loaded {
      opacity: 1;
    }
  </style>
  
  <!-- Load configuration first (critical for initialization) -->
  <script src="./assets/js/config.js"></script>
</head>

<body id="top">
  <!-- Initial loading indicator -->
  <div class="initial-loading" id="initialLoading">
    <div class="loading-spinner"></div>
    <div class="loading-text">Loading AI Chat...</div>
  </div>

  <!-- Environment indicator -->
  <div class="env-indicator" id="envIndicator">
    <span id="envText"></span>
  </div>

  <!-- Header -->
  <header class="header" data-header>
    <div class="container">
      <a href="index.html">
        <h1 class="logo">Aaai Solutions</h1>
      </a>
      <button class="nav-toggle-btn" aria-label="Toggle Menu" data-nav-toggle-btn>
        <ion-icon name="menu-outline" class="menu-icon"></ion-icon>
        <ion-icon name="close-outline" class="close-icon"></ion-icon>
      </button>
      <nav class="navbar container">
        <ul class="navbar-list">
          <li><a href="index.html" class="navbar-link" data-nav-link>Home</a></li>
          <li><a href="index.html#about" class="navbar-link" data-nav-link>About</a></li>
          <li><a href="index.html#solutions" class="navbar-link" data-nav-link>Solutions</a></li>
          <li><a href="index.html#applications" class="navbar-link" data-nav-link>Pursuits</a></li>
          <li><a href="index.html#contact" class="navbar-link" data-nav-link>Contact</a></li>
          <li><a href="https://calendly.com/shash-aaai/30min" class="btn btn-primary">Schedule a Demo</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <main class="main-content">
    <!-- Chat Layout Container -->
    <div class="chat-layout" id="chatLayout">
      <!-- Chat Sidebar -->
      <div class="chat-sidebar" id="chatSidebar">
        <!-- Sidebar Header -->
        <div class="sidebar-header">
          <h3 class="project-name" id="sidebarProjectName">Loading...</h3>
          <button class="collapse-btn" id="sidebarCollapseBtn" title="Collapse Sidebar">
            <ion-icon name="chevron-back-outline" id="collapseIcon"></ion-icon>
          </button>
        </div>

        <!-- Sidebar Content -->
        <div class="sidebar-content">
          <!-- Reel Management Section -->
          <div class="reel-management-container">
            <div class="reel-header">
                <h4>Chat Reels</h4>
                <button class="new-reel-btn" id="newReelBtn" title="Create New Reel">
                    <ion-icon name="add-outline"></ion-icon>
                </button>
            </div>
            
            <div class="current-reel-display">
                <div class="current-reel-label">Active Reel:</div>
                <div class="current-reel-name" id="currentReelTitle">No reel selected</div>
            </div>
            
            <div class="reel-list-container">
                <div class="reel-list" id="reelList">
                    <!-- Reel buttons will be populated here -->
                    <div class="empty-reel-list">
                        <ion-icon name="chatbubbles-outline"></ion-icon>
                        <span>Loading reels...</span>
                    </div>
                </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Chat Container -->
      <div class="chat-container" id="chatContainer">
        <!-- Status Indicators -->
        <div class="status-indicator status-connected">✓ Connected</div>
        <div class="status-indicator status-disconnected">✗ Disconnected</div>
        <div class="status-indicator status-reconnecting">⟳ Reconnecting...</div>
        
        <!-- Chat Header -->
        <div class="chat-header">
          <div class="chat-header-left">
            <button class="back-btn" id="backBtn" title="Back to Projects">
              <ion-icon name="arrow-back-outline"></ion-icon>
              <span>Projects</span>
            </button>
            <div class="chat-info">
              <h3 class="chat-title" id="chatTitle">New Chat</h3>
              <p class="chat-subtitle" id="chatSubtitle">Start your conversation</p>
            </div>
          </div>
          
          <div class="chat-header-right">
            <div class="connection-status" id="connectionStatus">
              <div class="connection-dot" id="connectionDot"></div>
              <span id="connectionText">Connecting...</span>
            </div>
            <div class="user-info">
              <span class="credits-badge" id="creditsDisplay">Credits: 0</span>
              <span id="userEmail">user@example.com</span>
            </div>
          </div>
        </div>
        
        <!-- Connection Error -->
        <div id="connectionError" class="connection-error" style="display:none;">
          <p>Connection error: Your session may have expired.</p>
          <button id="reconnectBtn" class="reconnect-btn">
            <ion-icon name="refresh-outline"></ion-icon>
            <span>Reconnect</span>
          </button>
        </div>

        <!-- Chat Body -->
        <div class="chat-body" id="chatBody">
          <!-- Welcome message -->
          <div class="welcome-message" id="welcomeMessage">
            <div class="welcome-icon">🤖</div>
            <h3>Start a New Conversation!</h3>
            <p>This is a fresh chat session. Ask questions, get insights, or explore ideas with your AI assistant.</p>
            <div class="welcome-suggestions">
              <button class="suggestion-btn" onclick="sendSuggestion('What can you help me with?')">What can you help me with?</button>
              <button class="suggestion-btn" onclick="sendSuggestion('Tell me about this project')">About this project</button>
              <button class="suggestion-btn" onclick="sendSuggestion('Give me some creative ideas')">Creative ideas</button>
            </div>
          </div>
          
          <!-- Messages will be inserted here -->
        </div>
        <!-- Chat Footer -->
        <div class="chat-footer">
          <textarea class="chat-input" id="messageInput" placeholder="Type your message here..." maxlength="1000" rows="1"></textarea>
          <button class="chat-send-btn" id="sendMessageBtn">
            <ion-icon name="send"></ion-icon>
            <span>Send</span>
          </button>
        </div>
      </div>
    </div>

    <!-- New Reel Modal -->
    <div class="modal-overlay" id="newReelModal">
      <div class="modal">
        <div class="modal-header">
          <h3 class="modal-title">Create New Reel</h3>
          <button class="modal-close" onclick="hideNewReelModal()">
            <ion-icon name="close-outline"></ion-icon>
          </button>
        </div>
        <form class="modal-form" id="newReelForm">
          <div class="form-group">
            <label class="form-label" for="reelName">Reel Name</label>
            <input type="text" class="form-input" id="reelName" placeholder="Enter reel name" required maxlength="100">
          </div>
          <div class="form-group">
            <label class="form-label" for="reelDescription">Description (Optional)</label>
            <textarea class="form-textarea" id="reelDescription" placeholder="Describe the purpose of this reel" maxlength="500"></textarea>
          </div>
          <div class="modal-actions">
            <button type="button" class="btn-secondary" onclick="hideNewReelModal()">Cancel</button>
            <button type="submit" class="btn-primary" id="createReelBtn">
              <span>Create Reel</span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer class="footer">
    <div class="container">
      <p class="copyright">
        &copy; 2024 <a href="#" class="copyright-link">Aaai Solutions</a>. All Rights Reserved
      </p>
      <ul class="footer-list">
        <li><a href="terms_conditions.html" class="footer-link">Terms & Conditions</a></li>
        <li><a href="privacy_policy.html" class="footer-link">Privacy Policy</a></li>
        <li><a href="https://docs.google.com/document/d/1ZH5H3gvn3b9xcXepwS9wx7juUfULOvW5MPSKCX3bYu4/edit?addon_store&pli=1#heading=h.ednect7ygrp2" class="footer-link">Bylaws</a></li>
      </ul>
    </div>
  </footer>

  <a href="#top" class="back-to-top" data-back-to-top>BACK TOP</a>

  <!-- Load non-critical CSS asynchronously -->
  <link rel="preload" href="./assets/css/style.css" as="style" onload="this.onload=null;this.rel='stylesheet'">

  <!-- Load scripts in parallel with async/defer -->
  <script defer src="./assets/js/script.js"></script>
  <script defer src="./assets/js/auth.js"></script>
  <script defer src="./assets/js/project-service.js"></script>
  <script defer src="./assets/js/navigation-manager.js"></script>
  <script defer src="./assets/js/websocket-manager.js"></script>
  <script defer src="./assets/js/chat-integration.js"></script>
  <script defer src="./assets/js/unified-init.js"></script>
  
  <!-- Load icons asynchronously -->
  <script type="module" src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.esm.js" async></script>
  <script nomodule src="https://unpkg.com/ionicons@5.5.2/dist/ionicons/ionicons.js" defer></script>
  
  <!-- Ultra-optimized chat application script -->
  <script>
    (function() {
        'use strict';
        
        // Ultra-fast initialization with performance monitoring
        const initStartTime = performance.now();
        
        // Hide loading indicator
        function hideLoadingIndicator() {
            const loadingEl = document.getElementById('initialLoading');
            const chatLayout = document.getElementById('chatLayout');
            
            if (loadingEl) {
                loadingEl.style.opacity = '0';
                setTimeout(() => {
                    loadingEl.style.display = 'none';
                }, 300);
            }
            
            if (chatLayout) {
                chatLayout.classList.add('loaded');
            }
        }
        
        // Show error with retry option
        function showInitializationError(error) {
            const loadingEl = document.getElementById('initialLoading');
            if (loadingEl) {
                loadingEl.innerHTML = `
                    <div style="text-align: center; color: #e74c3c;">
                        <h3>Initialization Failed</h3>
                        <p>${error.message}</p>
                        <button onclick="window.location.reload()" style="
                            background: var(--primary-gradient);
                            color: white;
                            border: none;
                            padding: 10px 20px;
                            border-radius: 5px;
                            cursor: pointer;
                            margin-top: 10px;
                        ">Retry</button>
                    </div>
                `;
            }
        }
        
        // Ultra-fast application initialization
        async function initializeChatApplicationUltraFast() {
            try {
                console.log('🚀 Ultra-fast chat application starting...');
                
                // Quick auth check first (non-blocking)
                const authCheck = new Promise((resolve) => {
                    const checkAuth = () => {
                        if (window.AuthService?.isAuthenticated()) {
                            resolve(true);
                        } else if (window.AuthService) {
                            resolve(false);
                        } else {
                            setTimeout(checkAuth, 10);
                        }
                    };
                    checkAuth();
                });
                
                // Wait for unified initialization in parallel
                const unifiedInitCheck = new Promise((resolve) => {
                    if (window.AAAI_APP?.initialized) {
                        resolve(true);
                    } else {
                        const checkInit = () => {
                            if (window.AAAI_APP?.initialized) {
                                resolve(true);
                            } else {
                                setTimeout(checkInit, 10);
                            }
                        };
                        checkInit();
                    }
                });
                
                // Parallel initialization
                const [authReady, unifiedReady] = await Promise.allSettled([authCheck, unifiedInitCheck]);
                
                if (authReady.status === 'fulfilled' && !authReady.value) {
                    console.log('❌ Authentication failed, redirecting to login');
                    window.location.href = 'login.html';
                    return;
                }
                
                // Get project context from URL (parallel)
                const urlParams = new URLSearchParams(window.location.search);
                const projectId = urlParams.get('project');
                const projectName = urlParams.get('project_name');
                
                if (!projectId) {
                    console.log('❌ No project ID, redirecting to projects');
                    window.location.href = 'project.html';
                    return;
                }
                
                console.log('✅ Basic checks passed, initializing chat integration...');
                
                // Parallel initialization of chat integration and UI setup
                const [chatReady, uiReady] = await Promise.allSettled([
                    initializeChatIntegrationParallel(),
                    setupUIParallel(projectId, projectName)
                ]);
                
                if (chatReady.status === 'rejected') {
                    throw chatReady.reason;
                }
                
                // Set project context in parallel
                if (window.ProductionChatIntegration?.setProjectContextParallel) {
                    // Use the new parallel method
                    window.ProductionChatIntegration.setProjectContextParallel(
                        projectId, 
                        projectName ? decodeURIComponent(projectName) : null
                    ).catch(error => {
                        console.warn('Project context setup warning:', error);
                    });
                } else if (window.ProductionChatIntegration?.setProjectContext) {
                    // Fallback to original method
                    window.ProductionChatIntegration.setProjectContext(
                        projectId, 
                        projectName ? decodeURIComponent(projectName) : null
                    );
                }
                
                // Setup event handlers (non-blocking)
                requestAnimationFrame(() => setupEventHandlersOptimized());
                
                // Hide loading indicator
                hideLoadingIndicator();
                
                const totalTime = performance.now() - initStartTime;
                console.log(`✅ Ultra-fast chat application initialized in ${totalTime.toFixed(2)}ms`);
                
            } catch (error) {
                console.error('❌ Ultra-fast initialization failed:', error);
                showInitializationError(error);
            }
        }
        
        // Parallel chat integration initialization
        async function initializeChatIntegrationParallel() {
            return new Promise((resolve, reject) => {
                const checkChatIntegration = () => {
                    if (window.ProductionChatIntegration) {
                        window.ProductionChatIntegration.initialize('chatContainer')
                            .then(resolve)
                            .catch(reject);
                    } else {
                        setTimeout(checkChatIntegration, 10);
                    }
                };
                checkChatIntegration();
            });
        }
        
        // Parallel UI setup
        async function setupUIParallel(projectId, projectName) {
            return new Promise((resolve) => {
                requestAnimationFrame(() => {
                    try {
                        // Update user info
                        const user = window.AuthService?.getCurrentUser();
                        if (user) {
                            const userEmail = document.getElementById('userEmail');
                            if (userEmail) userEmail.textContent = user.email;
                        }
                        
                        // Update project info
                        const chatTitle = document.getElementById('chatTitle');
                        const sidebarProjectName = document.getElementById('sidebarProjectName');
                        
                        if (projectName) {
                            const decodedName = decodeURIComponent(projectName);
                            if (chatTitle) chatTitle.textContent = decodedName;
                            if (sidebarProjectName) sidebarProjectName.textContent = decodedName;
                            document.title = `${decodedName} - AAAI Solutions`;
                        }
                        
                        resolve();
                    } catch (error) {
                        console.warn('UI setup warning:', error);
                        resolve(); // Don't fail initialization for UI issues
                    }
                });
            });
        }
        
        // Optimized event handlers setup
        function setupEventHandlersOptimized() {
            // Back button
            const backBtn = document.getElementById('backBtn');
            if (backBtn) {
                backBtn.addEventListener('click', () => {
                    window.location.href = 'project.html';
                });
            }
            
            // Send message functionality
            const sendBtn = document.getElementById('sendMessageBtn');
            const messageInput = document.getElementById('messageInput');
            
            if (sendBtn && messageInput) {
                // Optimized send message function
                const sendMessage = async () => {
                    const text = messageInput.value.trim();
                    if (text && window.ProductionChatIntegration) {
                        try {
                            await window.ProductionChatIntegration.sendMessage(text);
                        } catch (error) {
                            console.error('Failed to send message:', error);
                        }
                    }
                };
                
                sendBtn.addEventListener('click', sendMessage);
                
                messageInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });
            }
            
            // Form submission handling (optimized)
            const newReelForm = document.getElementById('newReelForm');
            const newReelModal = document.getElementById('newReelModal');
            
            if (newReelForm) {
                newReelForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    if (window.handleCreateReel) {
                        window.handleCreateReel(e);
                    }
                    return false;
                });
            }
            
            if (newReelModal) {
                newReelModal.addEventListener('click', function(e) {
                    if (e.target === newReelModal && window.hideNewReelModal) {
                        window.hideNewReelModal();
                    }
                });
            }
            
            // Sidebar collapse functionality
            const sidebarCollapseBtn = document.getElementById('sidebarCollapseBtn');
            const chatSidebar = document.getElementById('chatSidebar');
            const chatContainer = document.getElementById('chatContainer');
            const collapseIcon = document.getElementById('collapseIcon');
            
            if (sidebarCollapseBtn && chatSidebar && chatContainer) {
                sidebarCollapseBtn.addEventListener('click', function() {
                    const isCollapsed = chatSidebar.classList.contains('collapsed');
                    
                    if (isCollapsed) {
                        chatSidebar.classList.remove('collapsed');
                        chatContainer.classList.remove('sidebar-collapsed');
                        collapseIcon.setAttribute('name', 'chevron-back-outline');
                    } else {
                        chatSidebar.classList.add('collapsed');
                        chatContainer.classList.add('sidebar-collapsed');
                        collapseIcon.setAttribute('name', 'chevron-forward-outline');
                    }
                });
            }
        }
        
        // Global functions for reel modal (optimized)
        window.sendSuggestion = function(text) {
            if (window.ProductionChatIntegration) {
                window.ProductionChatIntegration.sendMessage(text).catch(error => {
                    console.error('Failed to send suggestion:', error);
                });
            }
        };
        
        window.showNewReelModal = function() {
            const modal = document.getElementById('newReelModal');
            const nameInput = document.getElementById('reelName');
            if (modal && nameInput) {
                modal.style.display = 'flex';
                nameInput.focus();
            }
        };

        window.hideNewReelModal = function() {
            const modal = document.getElementById('newReelModal');
            const form = document.getElementById('newReelForm');
            if (modal) {
                modal.style.display = 'none';
            }
            if (form) {
                form.reset();
            }
        };

        window.handleCreateReel = async function(event) {
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            const nameInput = document.getElementById('reelName');
            const descriptionInput = document.getElementById('reelDescription');
            const createBtn = document.getElementById('createReelBtn');
            
            if (!nameInput || !nameInput.value.trim()) {
                alert('Reel name is required');
                return false;
            }
            
            const reelName = nameInput.value.trim();
            const reelDescription = descriptionInput ? descriptionInput.value.trim() : '';
            
            try {
                if (createBtn) {
                    createBtn.disabled = true;
                    createBtn.classList.add('loading');
                }
                
                if (!window.ProductionChatIntegration) {
                    throw new Error('Chat service not available. Please refresh the page.');
                }
                
                const success = await window.ProductionChatIntegration.createReel(reelName, reelDescription);
                
                if (success) {
                    window.hideNewReelModal();
                    return true;
                } else {
                    throw new Error('Failed to create reel. Please try again.');
                }
                
            } catch (error) {
                console.error('Error creating reel:', error);
                alert('Failed to create reel: ' + error.message);
                return false;
            } finally {
                if (createBtn) {
                    createBtn.disabled = false;
                    createBtn.classList.remove('loading');
                }
            }
        };
        
        // Initialize when DOM is ready (non-blocking)
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                requestAnimationFrame(initializeChatApplicationUltraFast);
            });
        } else {
            requestAnimationFrame(initializeChatApplicationUltraFast);
        }
        
    })();
  </script>
</body>

</html>